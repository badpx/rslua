use super::inst_for::*;
use super::inst_load::*;
use super::inst_misc::*;
use super::inst_ops::*;
use super::inst_table::*;
use super::inst_call::*;
use super::inst_upvalue::*;
use super::opcodes::*;
use crate::api::LuaVM;


const MAXARG_BX: isize = (1 << 18) - 1; // 262143
const MAXARG_SBX: isize = MAXARG_BX >> 1; // 131071

/*
        31       22       13       5    0
         +-------+^------+-^-----+-^-----
  iABC:  |b=9bits |c=9bits |a=8bits|op=6|
         +-------+^------+-^-----+-^-----
  iABx:  |    bx=18bits    |a=8bits|op=6|
         +-------+^------+-^-----+-^-----
  iAsBx: |   sbx=18bits    |a=8bits|op=6|
         +-------+^------+-^-----+-^-----
  iAx:   |    ax=26bits            |op=6|
         +-------+^------+-^-----+-^-----
        31      23      15       7      0
*/
pub trait Instruction {
    fn opname(self) -> &'static str;
    fn opmode(self) -> u8;
    fn b_mode(self) -> u8;
    fn c_mode(self) -> u8;
    fn opcode(self) -> u8;
    fn abc(self) -> (isize, isize, isize);
    fn a_bx(self) -> (isize, isize);
    fn a_sbx(self) -> (isize, isize);
    fn ax(self) -> isize;
    fn execute(self, vm: &mut dyn LuaVM);
}

impl Instruction for u32 {
    fn opname(self) -> &'static str {
        OPCODES[self.opcode() as usize].name
    }

    fn opmode(self) -> u8 {
        OPCODES[self.opcode() as usize].opmode
    }

    fn b_mode(self) -> u8 {
        OPCODES[self.opcode() as usize].bmode
    }

    fn c_mode(self) -> u8 {
        OPCODES[self.opcode() as usize].cmode
    }

    fn opcode(self) -> u8 {
        self as u8 & 0x3F
    }

    fn abc(self) -> (isize, isize, isize) {
        let a = (self >> 6 & 0xFF) as isize;
        let c = (self >> 14 & 0x1FF) as isize;
        let b = (self >> 23 & 0x1FF) as isize;
        (a, b, c)
    }

    /*
            0               131071             262143
        Bx  |------------------+------------------|


          -131071              0               131072
       sBx  |------------------+------------------|
    */

    fn a_bx(self) -> (isize, isize) {
        let a = (self >> 6 & 0xFF) as isize;
        let bx = (self >> 14) as isize;
        (a, bx)
    }

    fn a_sbx(self) -> (isize, isize) {
        let (a, bx) = self.a_bx();
        (a, bx - MAXARG_SBX)
    }

    fn ax(self) -> isize {
        (self >> 6) as isize
    }

    fn execute(self, vm: &mut dyn LuaVM) {
        match self.opcode() {
            OP_MOVE => move_(self, vm),
            OP_LOADK => load_k(self, vm),
            OP_LOADKX => load_kx(self, vm),
            OP_LOADBOOL => load_bool(self, vm),
            OP_LOADNIL => load_nil(self, vm),
            // OP_GETUPVAL => (),
            OP_GETTABUP => get_tab_up(self, vm),
            OP_GETTABLE => get_table(self, vm),
            // OP_SETTABUP => (),
            // OP_SETUPVAL => (),
            OP_SETTABLE => set_table(self, vm),
            OP_NEWTABLE => new_table(self, vm),
            OP_SELF => self_(self, vm),
            OP_ADD => add(self, vm),
            OP_SUB => sub(self, vm),
            OP_MUL => mul(self, vm),
            OP_MOD => mod_(self, vm),
            OP_POW => pow(self, vm),
            OP_DIV => div(self, vm),
            OP_IDIV => idiv(self, vm),
            OP_BAND => band(self, vm),
            OP_BOR => bor(self, vm),
            OP_BXOR => bxor(self, vm),
            OP_SHL => bshl(self, vm),
            OP_SHR => bshr(self, vm),
            OP_UNM => unm(self, vm),
            OP_BNOT => bnot(self, vm),
            OP_NOT => not(self, vm),
            OP_LEN => length(self, vm),
            OP_CONCAT => concat(self, vm),
            OP_JMP => jmp(self, vm),
            OP_EQ => eq(self, vm),
            OP_LT => lt(self, vm),
            OP_LE => le(self, vm),
            OP_TEST => test(self, vm),
            OP_TESTSET => test_set(self, vm),
            OP_CALL => call(self, vm),
            OP_TAILCALL => tail_call(self, vm),
            OP_RETURN => return_(self, vm),
            OP_FORLOOP => for_loop(self, vm),
            OP_FORPREP => for_prep(self, vm),
            // OP_TFORCALL => (),
            // OP_TFORLOOP => (),
            OP_SETLIST => set_list(self, vm),
            OP_CLOSURE => closure(self, vm),
            OP_VARARG => vararg(self, vm),
            // OP_EXTRAARG => (),
            _ => {
                dbg!(self.opname());
                unimplemented!()
            }
        }
    }
}

#[cfg(test)]
mod tests {
    use crate::state;
    use crate::binary::{chunk, undump};
    use crate::api::LuaAPI;
    use crate::LuaState;
    use crate::binary::reader::tests::LUA_FOR_LOOP;
    use super::*;
    use std::rc::Rc;
    use std::cell::RefCell;
    
    /* Lua source code:
        print("Hello, world!")
    */
    const LUA_HELLO_CHUNK: &[u8] = &[
        0x1b, 0x4c, 0x75, 0x61, 0x53, 0x00, 0x19, 0x93, 0x0d, 0x0a, 0x1a, 0x0a,
        0x04, 0x08, 0x04, 0x08, 0x08, 0x78, 0x56, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x77, 0x40, 0x01, 0x0b, 0x40,
        0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2e, 0x6c, 0x75, 0x61, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00,
        0x06, 0x00, 0x40, 0x00, 0x41, 0x40, 0x00, 0x00, 0x24, 0x40, 0x00, 0x01,
        0x26, 0x00, 0x80, 0x00, 0x02, 0x00, 0x00, 0x00, 0x04, 0x06, 0x70, 0x72,
        0x69, 0x6e, 0x74, 0x04, 0x0e, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20,
        0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x5f, 0x45, 0x4e,
        0x56

    ];

    /* Lua source code:
        local t = {"a", "b", "c"}
        t[2] = "B"
        t["foo"] = "Bar"
        local s = t[3] .. t[2] .. t[1] .. t["foo"] .. #t
    */
    const LUA_TABLE_CHUNK:&[u8] = &[
        0x1b, 0x4c, 0x75, 0x61, 0x53, 0x00, 0x19, 0x93, 0x0d, 0x0a, 0x1a, 0x0a,
        0x04, 0x08, 0x04, 0x08, 0x08, 0x78, 0x56, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x77, 0x40, 0x01, 0x0b, 0x40,
        0x74, 0x61, 0x62, 0x6c, 0x65, 0x2e, 0x6c, 0x75, 0x61, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x0e, 0x00, 0x00, 0x00,
        0x0b, 0x00, 0x80, 0x01, 0x41, 0x00, 0x00, 0x00, 0x81, 0x40, 0x00, 0x00,
        0xc1, 0x80, 0x00, 0x00, 0x2b, 0x40, 0x80, 0x01, 0x0a, 0x00, 0xc1, 0x81,
        0x0a, 0x80, 0xc1, 0x82, 0x47, 0xc0, 0x41, 0x00, 0x87, 0xc0, 0x40, 0x00,
        0xc7, 0x00, 0x42, 0x00, 0x07, 0x41, 0x41, 0x00, 0x5c, 0x01, 0x00, 0x00,
        0x5d, 0x40, 0x81, 0x00, 0x26, 0x00, 0x80, 0x00, 0x09, 0x00, 0x00, 0x00,
        0x04, 0x02, 0x61, 0x04, 0x02, 0x62, 0x04, 0x02, 0x63, 0x13, 0x02, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x02, 0x42, 0x04, 0x04, 0x66,
        0x6f, 0x6f, 0x04, 0x04, 0x42, 0x61, 0x72, 0x13, 0x03, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x13, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x74, 0x05, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00,
        0x00, 0x02, 0x73, 0x0d, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x05, 0x5f, 0x45, 0x4e, 0x56
    ];

    /* Lua source code:
    local function max(...)
    local args = {...}
    local val, idx
    for i = 1, #args do
        if val == nil or args[i] > val then
        val, idx = args[i], i
        end
    end
    return val, idx
    end

    local function assert(v)
    if not v then fail() end
    end

    local v1 = max(3, 9, 7, 128, 35)
    assert(v1 == 128)
    local v2, i2 = max(3, 9, 7, 128, 35)
    assert(v2 == 128 and i2 == 4)
    local v3, i3 = max(max(3, 9, 7, 128, 35))
    assert(v3 == 128 and i3 == 1)
    local t = {max(3, 9, 7, 128, 35)}
    assert(t[1] == 128 and t[2] == 4)
    */
    const LUA_CALL_CHUNK:&[u8] = &[
        0x1b, 0x4c, 0x75, 0x61, 0x53, 0x00, 0x19, 0x93, 0x0d, 0x0a, 0x1a, 0x0a,
        0x04, 0x08, 0x04, 0x08, 0x08, 0x78, 0x56, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x77, 0x40, 0x01, 0x0a, 0x40,
        0x74, 0x65, 0x73, 0x74, 0x2e, 0x6c, 0x75, 0x61, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0e, 0x43, 0x00, 0x00, 0x00, 0x2c,
        0x00, 0x00, 0x00, 0x6c, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0xc1,
        0x00, 0x00, 0x00, 0x01, 0x41, 0x00, 0x00, 0x41, 0x81, 0x00, 0x00, 0x81,
        0xc1, 0x00, 0x00, 0xc1, 0x01, 0x01, 0x00, 0xa4, 0x80, 0x00, 0x03, 0xc0,
        0x00, 0x80, 0x00, 0x5f, 0xc0, 0x40, 0x01, 0x1e, 0x00, 0x00, 0x80, 0x03,
        0x41, 0x00, 0x00, 0x03, 0x01, 0x80, 0x00, 0xe4, 0x40, 0x00, 0x01, 0xc0,
        0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x41, 0x41, 0x00, 0x00, 0x81,
        0x81, 0x00, 0x00, 0xc1, 0xc1, 0x00, 0x00, 0x01, 0x02, 0x01, 0x00, 0xe4,
        0xc0, 0x00, 0x03, 0x40, 0x01, 0x80, 0x00, 0x1f, 0xc0, 0xc0, 0x01, 0x1e,
        0x40, 0x00, 0x80, 0x5f, 0x40, 0x41, 0x02, 0x1e, 0x00, 0x00, 0x80, 0x83,
        0x41, 0x00, 0x00, 0x83, 0x01, 0x80, 0x00, 0x64, 0x41, 0x00, 0x01, 0x40,
        0x01, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0xc1, 0x01, 0x00, 0x00, 0x01,
        0x42, 0x00, 0x00, 0x41, 0x82, 0x00, 0x00, 0x81, 0xc2, 0x00, 0x00, 0xc1,
        0x02, 0x01, 0x00, 0xa4, 0x01, 0x00, 0x03, 0x64, 0xc1, 0x00, 0x00, 0xc0,
        0x01, 0x80, 0x00, 0x1f, 0xc0, 0xc0, 0x02, 0x1e, 0x40, 0x00, 0x80, 0x5f,
        0x80, 0x41, 0x03, 0x1e, 0x00, 0x00, 0x80, 0x03, 0x42, 0x00, 0x00, 0x03,
        0x02, 0x80, 0x00, 0xe4, 0x41, 0x00, 0x01, 0xcb, 0x01, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x00, 0x41, 0x02, 0x00, 0x00, 0x81, 0x42, 0x00, 0x00, 0xc1,
        0x82, 0x00, 0x00, 0x01, 0xc3, 0x00, 0x00, 0x41, 0x03, 0x01, 0x00, 0x24,
        0x02, 0x00, 0x03, 0xeb, 0x41, 0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x47,
        0x82, 0xc1, 0x03, 0x1f, 0xc0, 0xc0, 0x04, 0x1e, 0x80, 0x00, 0x80, 0x47,
        0xc2, 0xc1, 0x03, 0x5f, 0x40, 0xc1, 0x04, 0x1e, 0x00, 0x00, 0x80, 0x43,
        0x42, 0x00, 0x00, 0x43, 0x02, 0x80, 0x00, 0x24, 0x42, 0x00, 0x01, 0x26,
        0x00, 0x80, 0x00, 0x08, 0x00, 0x00, 0x00, 0x13, 0x03, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x13, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x13, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x80,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x23, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x13, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x13, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x02,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0a, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x08, 0x15, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00,
        0x00, 0x6d, 0x00, 0x00, 0x00, 0x2b, 0x40, 0x00, 0x00, 0x44, 0x00, 0x80,
        0x00, 0xc1, 0x00, 0x00, 0x00, 0x1c, 0x01, 0x00, 0x00, 0x41, 0x01, 0x00,
        0x00, 0xe8, 0xc0, 0x01, 0x80, 0x5f, 0x40, 0xc0, 0x00, 0x1e, 0x80, 0x00,
        0x80, 0xc7, 0x81, 0x01, 0x00, 0x20, 0xc0, 0x81, 0x00, 0x1e, 0x80, 0x00,
        0x80, 0xc7, 0x81, 0x01, 0x00, 0x80, 0x00, 0x00, 0x03, 0x40, 0x00, 0x80,
        0x03, 0xe7, 0x80, 0xfd, 0x7f, 0xc0, 0x00, 0x80, 0x00, 0x00, 0x01, 0x00,
        0x01, 0xe6, 0x00, 0x80, 0x01, 0x26, 0x00, 0x80, 0x00, 0x02, 0x00, 0x00,
        0x00, 0x13, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x05,
        0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x05,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x09,
        0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x07,
        0x00, 0x00, 0x00, 0x05, 0x61, 0x72, 0x67, 0x73, 0x03, 0x00, 0x00, 0x00,
        0x15, 0x00, 0x00, 0x00, 0x04, 0x76, 0x61, 0x6c, 0x04, 0x00, 0x00, 0x00,
        0x15, 0x00, 0x00, 0x00, 0x04, 0x69, 0x64, 0x78, 0x04, 0x00, 0x00, 0x00,
        0x15, 0x00, 0x00, 0x00, 0x0c, 0x28, 0x66, 0x6f, 0x72, 0x20, 0x69, 0x6e,
        0x64, 0x65, 0x78, 0x29, 0x07, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,
        0x0c, 0x28, 0x66, 0x6f, 0x72, 0x20, 0x6c, 0x69, 0x6d, 0x69, 0x74, 0x29,
        0x07, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x0b, 0x28, 0x66, 0x6f,
        0x72, 0x20, 0x73, 0x74, 0x65, 0x70, 0x29, 0x07, 0x00, 0x00, 0x00, 0x11,
        0x00, 0x00, 0x00, 0x02, 0x69, 0x08, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x0e, 0x00,
        0x00, 0x00, 0x01, 0x00, 0x02, 0x05, 0x00, 0x00, 0x00, 0x22, 0x40, 0x00,
        0x00, 0x1e, 0x40, 0x00, 0x80, 0x46, 0x00, 0x40, 0x00, 0x64, 0x40, 0x80,
        0x00, 0x26, 0x00, 0x80, 0x00, 0x01, 0x00, 0x00, 0x00, 0x04, 0x05, 0x66,
        0x61, 0x69, 0x6c, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x05, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00,
        0x00, 0x0d, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x76, 0x00, 0x00, 0x00, 0x00, 0x05,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x5f, 0x45, 0x4e, 0x56,
        0x43, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00,
        0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
        0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
        0x10, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,
        0x11, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,
        0x11, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00,
        0x12, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00,
        0x12, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
        0x13, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
        0x13, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
        0x13, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
        0x14, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
        0x14, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
        0x14, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00,
        0x15, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00,
        0x15, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00,
        0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
        0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
        0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
        0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
        0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
        0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
        0x17, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
        0x04, 0x6d, 0x61, 0x78, 0x01, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00,
        0x07, 0x61, 0x73, 0x73, 0x65, 0x72, 0x74, 0x02, 0x00, 0x00, 0x00, 0x43,
        0x00, 0x00, 0x00, 0x03, 0x76, 0x31, 0x09, 0x00, 0x00, 0x00, 0x43, 0x00,
        0x00, 0x00, 0x03, 0x76, 0x32, 0x16, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00,
        0x00, 0x03, 0x69, 0x32, 0x16, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00,
        0x03, 0x76, 0x33, 0x27, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00, 0x03,
        0x69, 0x33, 0x27, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00, 0x02, 0x74,
        0x38, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x05, 0x5f, 0x45, 0x4e, 0x56
      ];


    #[test]
    fn test_forloop() {
        let proto = undump(LUA_FOR_LOOP.to_vec());
        let ls = execute(proto);
        let result = ls.borrow().stack().get(1);
        assert_eq!(result.to_integer(), Some(2550));
    }

    #[test]
    fn test_table() {
        let proto = undump(LUA_TABLE_CHUNK.to_vec());
        let ls = execute(proto);
        let result = ls.borrow().to_string(2);
        assert_eq!(result, "cBaBar3");
    }

    #[test]
    fn test_call_func() {
        let data = LUA_CALL_CHUNK.to_vec();
        let ls = Rc::new(RefCell::new(LuaState::new()));
        ls.borrow_mut().stack_mut().state = Some(Rc::downgrade(&ls));

        ls.borrow_mut().load(data, "dummy", "b");
        ls.borrow_mut().call(0, 0);
    }

    #[test]
    fn test_call_rust_func() {
        let data = LUA_HELLO_CHUNK.to_vec();
        let ls = Rc::new(RefCell::new(LuaState::new()));
        ls.borrow_mut().stack_mut().state = Some(Rc::downgrade(&ls));

        ls.borrow_mut().register("print", _print); // Register print function
        ls.borrow_mut().load(data, "chunk", "b");
        ls.borrow_mut().call(0, 0);
    }

    fn execute(proto: Rc<chunk::Prototype>) -> Rc<RefCell<LuaState>> {
        let regs_size = proto.max_stack_size;
        let ls = state::new_lua_state((regs_size + 8) as usize, proto);
        ls.borrow_mut().set_top(regs_size as isize);
        loop {
            let pc = ls.borrow_mut().pc();
            let inst = ls.borrow_mut().fetch();
            if inst.opcode() != OP_RETURN {
                inst.execute(&mut *ls.borrow_mut());
                //print!("[{:04}] {} ", pc + 1, inst.opname());
            } else {
                break;
            }
            //println!("{:?}", ls.borrow().stack()._raw_data());
        }
        ls 
    }

    fn _print(ls: &dyn crate::api::LuaAPI) -> usize {
        let nargs = ls.get_top();
        for i in 1..=nargs {
            if ls.is_boolean(i) {
                print!("{}", if ls.to_boolean(i) { "true" } else {"false"});
            } else if ls.is_string(i) {
                print!("{}", ls.to_string(i));
            } else {
                print!("{}", ls.type_name(ls.type_id(i)));
            }
            
            if i < nargs {
                print!("\t");
            }
        }
        println!("");
        0
    }
}
